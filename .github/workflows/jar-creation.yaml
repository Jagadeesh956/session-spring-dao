name: Build and Deploy to GitHub Packages (PAT)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          server-id: github
          server-username: ${{ github.actor }}
          server-password: ${{ secrets.GH_PACKAGES_TOKEN }}

      # -----------------------
      # DEBUG 1: Token exists
      # -----------------------
      - name: Debug - token existence
        env:
          GH_PACKAGES_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
        run: |
          if [ -z "$GH_PACKAGES_TOKEN" ]; then
            echo "❌ GH_PACKAGES_TOKEN is missing"
            exit 1
          fi
          echo "✅ GH_PACKAGES_TOKEN exists"

      # -----------------------
      # DEBUG 2: Token identity
      # -----------------------
      - name: Debug - token identity
        env:
          GH_PACKAGES_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
        run: |
          curl -s \
            -H "Authorization: Bearer $GH_PACKAGES_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/user

      # -----------------------
      # DEBUG 3: Package access
      # -----------------------
      - name: Debug - package access
        env:
          GH_PACKAGES_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GH_PACKAGES_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/user/packages)

          if [ "$STATUS" != "200" ]; then
            echo "❌ Token does NOT have package access (HTTP $STATUS)"
            exit 1
          fi

          echo "✅ Token has package access"

      # -----------------------
      # DEBUG 4: Maven settings
      # -----------------------
      - name: Debug - effective Maven settings
        run: mvn help:effective-settings

      # -----------------------
      # Build & Deploy
      # -----------------------
      - name: Build and deploy
        run: mvn clean deploy -B
