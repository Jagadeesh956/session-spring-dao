name: Build and Deploy to GitHub Packages

on:
  workflow_dispatch:

# REQUIRED — otherwise GITHUB_TOKEN is read-only
permissions:
  contents: read
  packages: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          server-id: github
          server-username: ${{ github.actor }}
          server-password: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------
      # DEBUG: Token existence
      # -----------------------
      - name: Debug - token existence
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "❌ GITHUB_TOKEN is missing"
            exit 1
          fi
          echo "✅ GITHUB_TOKEN exists"

      # -----------------------
      # DEBUG: Token permissions
      # -----------------------
      - name: Debug - token package access
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/user/packages)

          if [ "$STATUS" != "200" ]; then
            echo "❌ Token does NOT have package access (HTTP $STATUS)"
            exit 1
          fi

          echo "✅ Token has package access"

      # -----------------------
      # DEBUG: Maven settings
      # -----------------------
      - name: Debug - effective Maven settings
        run: mvn help:effective-settings

      # -----------------------
      # Build & Deploy
      # -----------------------
      - name: Build and deploy
        run: mvn clean deploy -B
