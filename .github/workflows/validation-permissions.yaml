name: Build & Deploy to GitHub Packages

on:
  workflow_dispatch:

# üî¥ CRITICAL: Without this, GITHUB_TOKEN is READ-ONLY
permissions:
  contents: read
  packages: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # Checkout source
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # Setup Java + Maven auth
      # -------------------------------
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          server-id: github
          server-username: ${{ github.actor }}
          server-password: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------------
      # DEBUG 1: Token existence
      # -------------------------------
      - name: Debug ‚Äì check GITHUB_TOKEN exists
        run: |
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "‚ùå GITHUB_TOKEN is NOT present"
            exit 1
          else
            echo "‚úÖ GITHUB_TOKEN is present"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------------
      # DEBUG 2: Token permissions (packages)
      # -------------------------------
      - name: Debug ‚Äì verify package access via GitHub API
        run: |
          echo "Calling GitHub Packages API..."
          curl -s -o response.json -w "%{http_code}" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/user/packages > status.txt

          STATUS=$(cat status.txt)
          cat response.json

          if [ "$STATUS" != "200" ]; then
            echo "‚ùå Token does NOT have package access (HTTP $STATUS)"
            exit 1
          else
            echo "‚úÖ Token has package access"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------------
      # DEBUG 3: Print Maven settings being used
      # -------------------------------
      - name: Debug ‚Äì show effective Maven settings
        run: mvn help:effective-settings

      # -------------------------------
      # Build + Deploy
      # -------------------------------
      - name: Build and deploy to GitHub Packages
        run: mvn clean deploy -B
